---
import Layout from '../layout/Layout.astro';
import "../styles/global.css";
---

<Layout title="Warenkorb">
  <div class="cart-container max-w-4xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6">Dein Warenkorb</h1>
    
    <ul id="cart-items" class="space-y-4" role="list">
      </ul>
    
    <p id="loading-msg" class="text-gray-500" aria-live="polite">Lade Warenkorb...</p>

    <div class="mt-8 border-t pt-4 flex justify-between items-center hidden" id="cart-summary">
        <span class="text-xl font-bold" aria-live="polite" aria-atomic="true">
            Gesamt: <span id="cart-total">0.00</span> €
        </span>
        <button class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition focus:ring-4 focus:ring-green-300 focus:outline-none">
            Zur Kasse
        </button>
    </div>
  </div>
</Layout>

<script>
    import { cartItems, removeProductFromCart } from '../stores/cartStore';

    const container = document.getElementById('cart-items');
    const summary = document.getElementById('cart-summary');
    const totalEl = document.getElementById('cart-total');
    const loadingMsg = document.getElementById('loading-msg');

    cartItems.subscribe(items => {
        if (!container) return;
        
        const products = Object.values(items);
        
        // Loading entfernen
        if (loadingMsg) loadingMsg.style.display = 'none';

        if (products.length === 0) {
            container.innerHTML = '<li class="text-gray-500 list-none">Der Warenkorb ist leer.</li>';
            if (summary) summary.classList.add('hidden');
            return;
        }

        if (summary) summary.classList.remove('hidden');

        // Liste rendern (als li)
        const base = import.meta.env.BASE_URL;
        container.innerHTML = products.map(item => `
            <li class="flex items-center justify-between border p-4 rounded bg-white shadow-sm">
                <div class="flex items-center gap-4">
                   <div class="w-16 h-16 bg-gray-100 rounded overflow-hidden">
                       <img src="${base}/Products/${item.image}" alt="${item.name}" class="object-cover w-full h-full" />
                   </div>
                   <div>
                       <h3 class="font-bold text-lg">${item.name}</h3>
                       <p class="text-sm text-gray-600">Einzelpreis: ${item.price.toFixed(2)} €</p>
                   </div>
                </div>
                <div class="flex items-center gap-6">
                    <span class="font-mono bg-gray-100 px-3 py-1 rounded" aria-label="Menge: ${item.quantity}">x${item.quantity}</span>
                    <span class="font-bold w-24 text-right">${(item.price * item.quantity).toFixed(2)} €</span>
                    
                    <button 
                        class="delete-btn text-red-500 hover:text-red-700 hover:bg-red-50 rounded transition-colors focus:ring-2 focus:ring-red-500 focus:outline-none flex items-center justify-center" 
                        data-id="${item.id}"
                        aria-label="${item.name} entfernen"
                        style="width: 44px; height: 44px;" 
                    >
                        <span aria-hidden="true" style="font-size: 1.2rem;">✕</span>
                    </button>
                </div>
            </li>
        `).join('');

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget as HTMLElement; // currentTarget ist sicherer bei Icons im Button
                const id = target.dataset.id;
                if (id) removeProductFromCart(id);
                // Fokus Management wäre hier der nächste Schritt (Fokus geht verloren wenn Element gelöscht wird),
                // aber für "Basic AA" ist das oben erstmal wichtiger.
            });
        });

        const total = products.reduce((acc, item) => acc + (item.price * item.quantity), 0);
        if (totalEl) totalEl.innerText = total.toFixed(2);
    });
</script>