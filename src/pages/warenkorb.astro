---
import Layout from '../layout/Layout.astro';
import "../styles/global.css";
---

<Layout title="Warenkorb">
  <div class="cart-container max-w-4xl mx-auto p-4 pb-32 sm:pb-4">
    <h1 class="text-2xl sm:text-3xl font-bold mb-6">Dein Warenkorb</h1>
    
    <ul id="cart-items" class="space-y-4" role="list">
    </ul>
    
    <p id="loading-msg" class="text-gray-500" aria-live="polite">Lade Warenkorb...</p>

    <div 
        class="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] z-40 
               sm:static sm:bg-transparent sm:shadow-none sm:p-0 sm:pt-6 sm:border-t sm:mt-8 hidden" 
        id="cart-summary"
    >
        <div class="max-w-4xl mx-auto flex flex-col sm:flex-row justify-between items-center gap-4">
            <span class="text-xl font-bold w-full sm:w-auto text-center sm:text-left" aria-live="polite" aria-atomic="true">
                Gesamt: <span id="cart-total">0.00</span> €
            </span>
            <button class="w-full sm:w-auto bg-green-600 text-white px-8 py-3 sm:py-2 rounded-lg font-semibold hover:bg-green-700 transition focus:ring-4 focus:ring-green-300 focus:outline-none shadow-sm">
                Zur Kasse
            </button>
        </div>
    </div>
  </div>
</Layout>

<script>
    import { cartItems, removeProductFromCart } from '../stores/cartStore';

    const container = document.getElementById('cart-items');
    const summary = document.getElementById('cart-summary');
    const totalEl = document.getElementById('cart-total');
    const loadingMsg = document.getElementById('loading-msg');

    cartItems.subscribe(items => {
        if (!container) return;
        
        const products = Object.values(items);
        
        // Loading entfernen
        if (loadingMsg) loadingMsg.style.display = 'none';

        if (products.length === 0) {
            container.innerHTML = '<li class="text-gray-500 list-none">Der Warenkorb ist leer.</li>';
            if (summary) summary.classList.add('hidden');
            return;
        }

        if (summary) summary.classList.remove('hidden');

        const base = import.meta.env.BASE_URL;
        
        // Responsive Template String
        container.innerHTML = products.map(item => `
            <li class="flex flex-col sm:flex-row sm:items-center justify-between border p-4 rounded-lg bg-white shadow-sm gap-4 transition-all">
                
                <div class="flex items-center gap-4 w-full sm:w-auto">
                   <div class="w-20 h-20 sm:w-16 sm:h-16 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
                       <img src="${base}/Products/${item.image}" alt="" class="object-cover w-full h-full" />
                   </div>
                   <div class="flex-grow">
                       <h3 class="font-bold text-lg leading-tight">${item.name}</h3>
                       <p class="text-sm text-gray-600 mt-1">Einzelpreis: ${item.price.toFixed(2)} €</p>
                   </div>
                </div>

                <div class="flex items-center justify-between sm:justify-end gap-4 w-full sm:w-auto border-t sm:border-t-0 pt-3 sm:pt-0 border-gray-100">
                    
                    <span class="font-mono bg-gray-100 px-3 py-1 rounded text-sm font-medium text-gray-700" aria-label="Menge: ${item.quantity}">
                        Anzahl: ${item.quantity}
                    </span>
                    
                    <div class="flex items-center gap-4">
                        <span class="font-bold text-lg sm:w-24 sm:text-right">
                            ${(item.price * item.quantity).toFixed(2)} €
                        </span>
                        
                        <button 
                            class="delete-btn text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors focus:ring-2 focus:ring-red-500 focus:outline-none flex items-center justify-center flex-shrink-0" 
                            data-id="${item.id}"
                            aria-label="${item.name} entfernen"
                            style="width: 44px; height: 44px;" 
                        >
                            <span aria-hidden="true" class="text-xl">✕</span>
                        </button>
                    </div>
                </div>
            </li>
        `).join('');

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const target = e.currentTarget as HTMLElement;
                const id = target.dataset.id;
                if (id) removeProductFromCart(id);
            });
        });

        const total = products.reduce((acc, item) => acc + (item.price * item.quantity), 0);
        if (totalEl) totalEl.innerText = total.toFixed(2);
    });
</script>